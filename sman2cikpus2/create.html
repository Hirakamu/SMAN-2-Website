<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Create Article â€” SMAN 2 Cikarang Pusat</title>
    <script src="./assets/hira.sman2.frmwrk.js"></script> <!-- CHANGE THIS BEFORE PRODUCTION -->
</head>

<body>
    <header></header>
    <main style="max-width:900px;margin:40px auto;font-family:Segoe UI,system-ui,Arial;">
        <h1>Create Article</h1>


        <form id="create-form">
            <label>Title<br><input id="title" required style="width:100%"></label><br><br>
            <label>Date (optional)<br><input id="date" type="date" style="width:200px"></label><br><br>
            <label>Image URL (optional)<br><input id="img" style="width:100%"></label><br><br>
            <label>Content (Markdown)<br><textarea id="content" rows="12"
                    style="width:100%;font-family:monospace; border:none; outline:none; resize:both;"></textarea></label><br><br>


            <button type="submit">Create</button>
            <button type="button" id="previewBtn">Preview</button>
        </form>


        <section id="preview" style="margin-top:24px;display:none;">
            <h2>Preview</h2>
            <hr>
            <br>
            <div id="preview-area"></div>
            <br>
            <hr>
        </section>


        <div id="status" style="margin-top:18px;color:green"></div>
    </main>


    <script type="module">
        const backendurl = 'http://localhost:5000'; // change to production URL when deployed


        function unSpace(text) {
            return text.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        }


        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const date = document.getElementById('date').value || new Date().toISOString().slice(0, 10);
            const img = document.getElementById('img').value.trim() || null;
            const content = document.getElementById('content').value;
            if (!title || !content) return alert('Title and content are required');


            const payload = { title, date, img, content };


            try {
                const res = await fetch(`${backendurl}/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                document.getElementById('status').textContent = 'Created: ' + data.path;
                // navigate to baca page using title (server looks up by title)
                location.href = `baca.html?title=${encodeURIComponent(title)}`;
            } catch (err) {
                document.getElementById('status').style.color = 'red';
                document.getElementById('status').textContent = 'Error: ' + err.message;
                console.error(err);
            }
        });


        document.getElementById('previewBtn').addEventListener('click', async () => {
            const content = document.getElementById('content').value;
            if (!content) return alert('No content to preview');
            // load marked from CDN
            try {
                const { marked } = await import('https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js');
                document.getElementById('preview-area').innerHTML = marked.parse(content);
                document.getElementById('preview').style.display = 'block';
            } catch (e) {
                alert('Failed to load markdown preview: ' + e.message);
            }
        });
    </script>